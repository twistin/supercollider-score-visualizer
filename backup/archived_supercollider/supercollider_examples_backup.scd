// ‚úÖ SC Score Visualizer - VERSI√ìN DEFINITIVA ROBUSTA
// Puerto OSC: 57124

// =====================================================================
// üéØ INSTRUCCIONES PASO A PASO:
// =====================================================================
// 1. SELECCIONA TODO EL C√ìDIGO (Cmd+A)
// 2. EJECUTA TODO (Cmd+Return)
// 3. ESPERA el mensaje "üéâ LISTO PARA USAR"
// 4. EJECUTA: scvTest()
//
// ‚ö†Ô∏è  FUNCIONES DISPONIBLES DESPU√âS DE CARGAR:
//    scvTest()          <- PRINCIPAL (usa esta)
//    scvXenakis()       <- Composici√≥n avanzada
//    scvQuick()         <- Demo r√°pido
// =====================================================================

(
// Variables del sistema
var osc, sendPoint, sendGliss, sendCluster, sendNoise, sendMass;
var testBasic, compositionXenakis, quickDemo;

"üöÄ Cargando SC Score Visualizer...".postln;

// Conexi√≥n OSC
osc = NetAddr.new("127.0.0.1", 57124);
"üì° OSC configurado en puerto 57124".postln;

// ========== FUNCIONES DE ENV√çO ==========

sendPoint = { |freq=440, amp=0.5, dur=1.0|
    osc.sendMsg("/event", "point", freq, amp, dur, 0.1, 0.1, 0.5, 0.0, 0.0, 220);
    ("‚úÖ Punto: " ++ freq ++ "Hz, " ++ dur ++ "s").postln;
};

sendGliss = { |startFreq=220, endFreq=880, amp=0.7, dur=3.0|
    osc.sendMsg("/event", "gliss", startFreq, endFreq, amp, dur, 0, 0.1, 0.1, 0.7, 0.2, 0.1, 120);
    ("‚úÖ Glissando: " ++ startFreq ++ " ‚Üí " ++ endFreq ++ "Hz").postln;
};

sendCluster = { |centerFreq=500, spread=100, voices=6, amp=0.6, dur=2.0|
    osc.sendMsg("/event", "cluster", centerFreq, spread, voices, amp, dur, 0.1, 0.1, 0.8, 0.3, 0.4, 180);
    ("‚úÖ Cluster: " ++ centerFreq ++ "Hz ¬±" ++ spread ++ ", " ++ voices ++ " voces").postln;
};

sendNoise = { |centerFreq=1000, bandwidth=500, amp=0.4, dur=2.0|
    osc.sendMsg("/event", "noise", centerFreq, bandwidth, amp, dur, 1.0, 0, 0.1, 0.1, 0.6, 0.8, 0.4, 60);
    ("‚úÖ Ruido: " ++ centerFreq ++ "Hz ¬±" ++ bandwidth).postln;
};

sendMass = { |components=4, amp=0.5, dur=3.0|
    var freqs = Array.fill(components, { 200 + 1500.rand });
    var amps = Array.fill(components, { 0.3 + 0.7.rand });
    var profile = [freqs, amps].flop.flatten;
    var args = ["mass", components, amp, dur, 0.3, 0.2, 0.1, 0.1, 0.9, 0.5, 0.7, 280] ++ profile;
    osc.sendMsg("/event", *args);
    ("‚úÖ Masa sonora: " ++ components ++ " componentes").postln;
};

// ========== DEMOS Y PRUEBAS ==========

testBasic = {
    "üß™ === PRUEBA B√ÅSICA (5 eventos) ===".postln;

    sendPoint.(440, 0.7, 2.0);

    { 2.5.wait; sendGliss.(220, 880, 0.8, 3.0); }.fork;
    { 4.wait; sendCluster.(660, 150, 8, 0.6, 4.0); }.fork;
    { 6.wait; sendNoise.(1000, 500, 0.5, 2.5); }.fork;
    { 8.wait; sendMass.(6, 0.6, 3.0);
      { 3.5.wait; "‚úÖ === PRUEBA COMPLETADA ===".postln; }.fork;
    }.fork;
};

compositionXenakis = {
    "üéº === COMPOSICI√ìN ESTILO XENAKIS ===".postln;

    // Puntos dispersos (Metastasis)
    {
        20.do { |i|
            var freq = 100 + (3000 * (i/20)) + 100.rand2;
            var amp = 0.3 + 0.4.rand;
            var dur = 0.5 + 1.5.rand;
            sendPoint.(freq, amp, dur);
            (0.2 + 0.8.rand).wait;
        };
    }.fork;

    // Glissandi (Pithoprakta)
    {
        3.wait;
        8.do { |i|
            var start = 200 + 1000.rand;
            var end = 200 + 1000.rand;
            var dur = 2.0 + 3.0.rand;
            sendGliss.(start, end, 0.5 + 0.3.rand, dur);
            (dur * 0.3).wait;
        };
    }.fork;

    // Clusters estoc√°sticos
    {
        8.wait;
        6.do { |i|
            var center = 300 + 1200.rand;
            var spread = 50 + 150.rand;
            var voices = 4 + 8.rand;
            sendCluster.(center, spread, voices, 0.4 + 0.3.rand, 3.0 + 2.0.rand);
            (1.0 + 2.0.rand).wait;
        };
    }.fork;

    "üéµ Duraci√≥n total: ~30 segundos".postln;
};

quickDemo = {
    "‚ö° === DEMO R√ÅPIDO ===".postln;
    sendPoint.(330, 0.6, 1.0);
    { 1.2.wait; sendGliss.(440, 880, 0.7, 2.0); }.fork;
    { 2.5.wait; sendCluster.(550, 100, 6, 0.5, 2.5); }.fork;
};

// ========== EXPORTAR A VARIABLES GLOBALES ==========

// Funciones principales (estas son las que vas a usar)
scvTest = testBasic;
scvXenakis = compositionXenakis;
scvQuick = quickDemo;

// Funciones de env√≠o directo
scvSendPoint = sendPoint;
scvSendGliss = sendGliss;
scvSendCluster = sendCluster;
scvSendNoise = sendNoise;
scvSendMass = sendMass;

// Verificar que las funciones se exportaron correctamente
if(scvTest.notNil, {
    "‚úÖ scvTest exportada correctamente".postln;
}, {
    "‚ùå ERROR: scvTest no se export√≥".postln;
});

if(scvXenakis.notNil, {
    "‚úÖ scvXenakis exportada correctamente".postln;
}, {
    "‚ùå ERROR: scvXenakis no se export√≥".postln;
});

if(scvQuick.notNil, {
    "‚úÖ scvQuick exportada correctamente".postln;
}, {
    "‚ùå ERROR: scvQuick no se export√≥".postln;
});

// ========== MENSAJE FINAL ==========

0.5.wait;

"".postln;
"üéâ ‚úÖ ‚úÖ ‚úÖ LISTO PARA USAR ‚úÖ ‚úÖ ‚úÖ".postln;
"".postln;
"üìã FUNCIONES PRINCIPALES DISPONIBLES:".postln;
"  ‚Ä¢ scvTest()          - Prueba b√°sica (RECOMENDADO EMPEZAR AQU√ç)".postln;
"  ‚Ä¢ scvXenakis()       - Composici√≥n estilo Xenakis".postln;
"  ‚Ä¢ scvQuick()         - Demo r√°pido".postln;
"".postln;
"‚ö†Ô∏è  IMPORTANTE: Usa exactamente estos nombres (sin 'BasicEvents' ni otros sufijos)".postln;
"".postln;
"üì¶ FUNCIONES DE ENV√çO DIRECTO:".postln;
"  ‚Ä¢ scvSendPoint(freq, amp, dur)".postln;
"  ‚Ä¢ scvSendGliss(startFreq, endFreq, amp, dur)".postln;
"  ‚Ä¢ scvSendCluster(center, spread, voices, amp, dur)".postln;
"  ‚Ä¢ scvSendNoise(center, bandwidth, amp, dur)".postln;
"  ‚Ä¢ scvSendMass(components, amp, dur)".postln;
"".postln;
"üöÄ PRUEBA AHORA: scvTest()".postln;
"üì° Puerto OSC: 57124".postln;
"üéØ Aseg√∫rate de que el visualizador Rust est√© corriendo".postln;
"".postln;

// ========== PRUEBA FINAL ==========
"üîç Probando acceso a funciones globales...".postln;
if(scvTest.isFunction, {
    "‚úÖ scvTest() est√° lista para usar".postln;
}, {
    "‚ùå ERROR CR√çTICO: scvTest no es una funci√≥n v√°lida".postln;
});

) // Fin del bloque principal

// =====================================================================
// üéØ GU√çA DE USO R√ÅPIDO:
// =====================================================================
//
// 1. Si todo sali√≥ bien, deber√≠as ver "‚úÖ scvTest() est√° lista para usar"
// 2. Ejecuta simplemente: scvTest()
// 3. NO uses nombres como "scvTestBasicEvents" - NO EXISTEN
// 4. Si hay errores, vuelve a ejecutar todo el bloque ( ... ) de arriba
//
// =====================================================================
